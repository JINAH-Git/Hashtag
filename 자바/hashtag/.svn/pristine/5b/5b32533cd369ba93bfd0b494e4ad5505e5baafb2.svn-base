<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ page import="hashtag.dao.*" %>
<%@ page import="hashtag.dto.*" %>
<%@ page import="hashtag.vo.*" %>
<%@ page import="java.util.*" %>
<%
request.setCharacterEncoding("EUC-KR");

String refine = request.getParameter("refine");
if(refine == null) refine = "원천";
String region = request.getParameter("region");
if(region == null) region = "전체";
String searchVal = request.getParameter("searchVal");
if(searchVal == null) searchVal = "전체";
String keyword = request.getParameter("keyword");
if(keyword == null) keyword = "";
int pageNo = 1;
try
{
	pageNo = Integer.parseInt(request.getParameter("page"));
}catch(Exception e){};

//--- 전 페이지에서 넘어온 검색어인 searchText에 바꿀 문자열을 추가하여 searchTemp 에 대입합니다.
//keyword = "<font color='red' bgcolor='black'>" + keyword + "</font>";
%>
<!DOCTYPE html>
<html>
	<head>
		<meta charset="EUC-KR">
		<title>크롤링한 데이터 확인</title>
		<script src="/hashtag/js/jquery-3.7.0.js"></script>
	</head>
	<body>
		<script>
		window.onload = function()
		{
			$("#keyword").focus();
			$("#keyword").val("<%= keyword %>");
			$("#keyword").css("text-align","right");
			
			if($("#searchVal").val() == "전체" && $("#keyword").val() != "")
			{
				var keyword = $("#keyword").val();
				cn1 = document.getElementsByClassName("title");
				for(i = 0 ; i < cn1.length; i++)
				{
					id = cn1[i].getAttribute("id");
					title = $("#"+id).text();
					$("#"+id).html(title.replaceAll(keyword,"<span style='background: black; color: yellow;'>" + keyword + "</span>"))
				}
				cn2 = document.getElementsByClassName("note");
				for(i = 0 ; i < cn2.length; i++)
				{
					id = cn2[i].getAttribute("id");
					note = $("#"+id).text();
					$("#"+id).html(note.replaceAll(keyword,"<span style='background: black; color: yellow;'>" + keyword + "</span>"));
				}
				cn3 = document.getElementsByClassName("tag");
				for(i = 0 ; i < cn3.length; i++)
				{
					id = cn3[i].getAttribute("id");
					tag = $("#"+id).text();
					$("#"+id).html(tag.replaceAll(keyword,"<span style='background: black; color: yellow;'>" + keyword + "</span>"))
				}
			}
			if($("#searchVal").val() == "제목" && $("#keyword").val() != "")
			{
				var keyword = $("#keyword").val();
				cn = document.getElementsByClassName("title");
				for(i = 0 ; i < cn.length; i++)
				{
					id = cn[i].getAttribute("id");
					title = $("#"+id).text();
					$("#"+id).html(title.replaceAll(keyword,"<span style='background: black; color: yellow;'>" + keyword + "</span>"))
				}
			}
			if($("#searchVal").val() == "내용" && $("#keyword").val() != "")
			{
				var keyword = $("#keyword").val();
				cn = document.getElementsByClassName("note");
				for(i = 0 ; i < cn.length; i++)
				{
					id = cn[i].getAttribute("id");
					note = $("#"+id).text();
					$("#"+id).html(note.replaceAll(keyword,"<span style='background: black; color: yellow;'>" + keyword + "</span>"));
				}
			}
			if($("#searchVal").val() == "해시태그" && $("#keyword").val() != "")
			{
				var keyword = $("#keyword").val();
				cn = document.getElementsByClassName("tag");
				for(i = 0 ; i < cn.length; i++)
				{
					id = cn[i].getAttribute("id");
					console.log(id);
					tag = $("#"+id).text();
					$("#"+id).html(tag.replaceAll(keyword,"<span style='background: black; color: yellow;'>" + keyword + "</span>"))
				}
			}
		}
		</script>
		<table align="center">
			<tr>
				<td>
					<form action="data.jsp" method="get">
						<select name="refine">
							<option value="원천" <%= refine.equals("원천") ? "selected" : "" %>>원천데이터</option>
							<option value="정제" <%= refine.equals("정제") ? "selected" : "" %>>정제데이터</option>
						</select>
						<select name="region">
							<option value="전체" <%= region.equals("전체") ? "selected" : "" %>>지역</option>
							<option value="전주" <%= region.equals("전주") ? "selected" : "" %>>전주</option>
							<option value="완주" <%= region.equals("완주") ? "selected" : "" %>>완주</option>
							<option value="군산" <%= region.equals("군산") ? "selected" : "" %>>군산</option>
							<option value="익산" <%= region.equals("익산") ? "selected" : "" %>>익산</option>
						</select>
						<select name="searchVal" id="searchVal">
							<option value="전체" <%= searchVal.equals("전체") ? "selected" : "" %>>제목+내용+해시태그</option>
							<option value="제목" <%= searchVal.equals("제목") ? "selected" : "" %>>제목</option>
							<option value="내용" <%= searchVal.equals("내용") ? "selected" : "" %>>내용</option>
							<option value="해시태그" <%= searchVal.equals("해시태그") ? "selected" : "" %>>해시태그</option>
						</select>
						<input type="text" name="keyword" id="keyword" placeholder="키워드를 입력하세요.">
						<input type="submit" value="검색">
					</form>
				</td>
			</tr>
		</table>
		<%
		DataDTO dto = new DataDTO();
		int totalData = dto.GetTotalData(refine,region,searchVal,keyword);
		%>
		<p style="text-align: center; font-size: 20px; color: blue;">수집한 <b style="color: red"><%= refine %></b>데이터 중 입력하신 조건(지역:<b style="color: red"><%= region %></b>,검색범위:<b style="color: red"><%= searchVal %></b>,검색어:<b style="color: red"><%= keyword %></b>)의 데이터는 총 <b style="color: red"><%= totalData %></b>개입니다.</p>
		<table align="center" border="1" style="width: 1300px; text-align: center; table-layout: fixed; margin-top: 50px; font-size: 12px">
			<tr>
				<th width="200px">블로그주소</th>
				<th width="100px">제목</th>
				<th width="100px">작성일</th>
				<th width="570px">내용</th>
				<th width="200px">해시태그</th>
				<th width="50px">공감수</th>
				<th width="80px">지역해시태그</th>
			</tr>
			<%
			DataDTO dto2 = new DataDTO();
			if(refine.equals("원천"))
			{
				ArrayList<DataVO> list = dto2.List(region,searchVal,keyword,pageNo);
				for(DataVO vo:list)
				{
					%>
					<tr>
						<td style="overflow: hidden;"><a href="<%= vo.getBlogaddress()%>"><%= vo.getBlogaddress() %></a></td>
						<td id="title<%= vo.getDno() %>" class="title"><%= vo.getTitle() %></td>
						<td><%= vo.getWdate() %></td>
						<td><div id="note<%= vo.getDno() %>" class="note" style="height: 250px; overflow-y:scroll"><%= vo.getNote() %></div></td>
						<td id="tag<%= vo.getDno() %>" class="tag"><%= vo.getHashtag() %></td>
						<td><%= vo.getHeart() %></td>
						<td><%= vo.getRegion() %></td>
					</tr>
					<%
				}
			}
			if(refine.equals("정제"))
			{
				ArrayList<CrawlingdataVO> list = dto.List2(region,searchVal,keyword,pageNo);
				for(CrawlingdataVO vo:list)
				{
					%>
					<tr>
						<td style="overflow: hidden;"><a href="<%= vo.getCdblogaddress()%>"><%= vo.getCdblogaddress() %></a></td>
						<td id="title<%= vo.getCdno() %>" class="title"><%= vo.getCdtitle() %></td>
						<td><%= vo.getCdwdate() %></td>
						<td><div id="note<%= vo.getCdno() %>" class="note" style="height: 250px; overflow-y:scroll"><%= vo.getCdnote() %></div></td>
						<td id="tag<%= vo.getCdno() %>" class="tag"><%= vo.getCdhashtag() %></td>
						<td><%= vo.getCdheart() %></td>
						<td><%= vo.getCdregion() %></td>
					</tr>
					<%
				}
			}
			%>
		</table>
		<table align="center" border="1" style="width: 1300px; margin-top: 10px; text-align: center;">
			<tr>
				<td>
				<%
				//마지막 페이지 설정
				int endPage = (int)(totalData / 10) + 1;
				if(endPage % 10 == 0) endPage--;
				//화면에 보이는 페이지 숫자의 개수 설정
				int displayNum = 20; 
				//화면에 보이는 페이지 숫자 중 시작번호
				int startBlock = pageNo - (pageNo % displayNum) + 1 ;
				if(pageNo % 20 == 0) startBlock = startBlock - displayNum;
				//화면에 보이는 페이지 숫자 중 끝번호
				int endBlock = startBlock + displayNum - 1;
				if(endBlock >= endPage) endBlock = endPage;
				//화면에 보일 페이지 구현
				if(startBlock != 1)
				{
					%>
					<a href="data.jsp?region=<%= region %>&searchVal=<%= searchVal %>&keyword=<%= keyword %>&page=1">시작</a>
					<a href="data.jsp?region=<%= region %>&searchVal=<%= searchVal %>&keyword=<%= keyword %>&page=<%= startBlock-1 %>">이전</a>
					<%
				}
				for(int i = startBlock; i <= endBlock; i++)
				{
					if(pageNo == i)
					{
						%>
						<a href="data.jsp?region=<%= region %>&searchVal=<%= searchVal %>&keyword=<%= keyword %>&page=<%= i %>" style="color: red; font-weight: bold;"><%= i %></a>
						<%
					}else
					{
						%>
						<a href="data.jsp?region=<%= region %>&searchVal=<%= searchVal %>&keyword=<%= keyword %>&page=<%= i %>"><%= i %></a>
						<%
					}
				}
				if(endBlock != endPage)
				{
					%>
					<a href="data.jsp?region=<%= region %>&searchVal=<%= searchVal %>&keyword=<%= keyword %>&page=<%= endBlock+1 %>">다음</a>
					<a href="data.jsp?region=<%= region %>&searchVal=<%= searchVal %>&keyword=<%= keyword %>&page=<%= endPage %>">마지막</a>
					<%
				}
				%>
				</td>
			</tr>
		</table>
	</body>
</html>